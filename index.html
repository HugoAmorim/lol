<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerenciador de Treinos</title>

<!-- FULLCALENDAR -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: Arial;
    }

    .hidden { display: none; }

    #login-box, #main {
        padding: 20px;
    }

    input, select, button {
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        border: none;
    }

    button {
        background: #4CAF50;
        color: white;
        cursor: pointer;
    }

    #calendar {
        background: white;
        color: black;
        padding: 10px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .box {
        background: #222;
        padding: 15px;
        margin-top: 10px;
        border-radius: 8px;
    }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-box">
    <h2>Login</h2>
    <input id="login-name" placeholder="Digite seu nickname">
    <button id="login-btn">Entrar</button>
</div>

<!-- PRINCIPAL -->
<div id="main" class="hidden">
    <h2>Bem-vindo, <span id="player-name"></span></h2>

    <div class="box">
        <h3>Criar Evento</h3>
        <input id="event-title" placeholder="Título do evento"><br>
        <input type="datetime-local" id="event-date"><br>
        <button id="add-event-btn">Criar Evento</button>
    </div>

    <div class="box">
        <h3>Confirmar Presença</h3>
        <select id="presence-event-select"></select><br>
        <button id="confirm-presence-btn">Confirmar Presença</button>
        <ul id="presence-list"></ul>
    </div>

    <div class="box">
        <h3>Remover Evento</h3>
        <select id="remove-event-select"></select><br>
        <button id="remove-event-btn" style="background:red;">Remover</button>
    </div>

    <div id="calendar"></div>
</div>

<!-- SUPABASE (UMD PARA O BROWSER) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>

<script>
/* ================ CONFIG SUPABASE ================ */
const supabaseUrl = "https://omhpfutnbrjkctdsnqzm.supabase.co";
const supabaseKey =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taHBmdXRuYnJqa2N0ZHNucXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTc5MDIsImV4cCI6MjA4MDE3MzkwMn0.ivNsJ21QVegUSgdc4aw9dyV85QJuEq7--bpkcKj5zVI";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* HTML ELEMENTOS */
const loginBox = document.getElementById('login-box');
const mainBox = document.getElementById('main');
const loginBtn = document.getElementById('login-btn');
const loginInput = document.getElementById('login-name');
const playerNameSpan = document.getElementById('player-name');

const addEventBtn = document.getElementById('add-event-btn');
const eventTitleInput = document.getElementById('event-title');
const eventDateInput = document.getElementById('event-date');

const presenceSelect = document.getElementById('presence-event-select');
const confirmPresenceBtn = document.getElementById('confirm-presence-btn');
const presenceList = document.getElementById('presence-list');

const removeSelect = document.getElementById('remove-event-select');
const removeBtn = document.getElementById('remove-event-btn');

const calendarEl = document.getElementById('calendar');

let calendar = null;
let currentUser = null;
let eventsLoaded = [];

/* LOGIN */
loginBtn.addEventListener('click', login);
loginInput.addEventListener('keyup', e => { if (e.key === 'Enter') login(); });

function login() {
    const name = loginInput.value.trim();
    if (!name) return alert("Digite um nickname!");

    currentUser = name;
    localStorage.setItem("lol_user", name);

    loadUser();
}

function loadUser() {
    const saved = localStorage.getItem("lol_user");
    if (!saved) return;

    currentUser = saved;
    playerNameSpan.innerText = saved;

    loginBox.classList.add('hidden');
    mainBox.classList.remove('hidden');

    initCalendar();
    loadEvents();
}

/* CARREGAR EVENTOS */
async function loadEvents() {
    const { data, error } = await supabaseClient
        .from("events")
        .select("*")
        .order("start");

    if (error) {
        alert("Erro ao carregar eventos: " + error.message);
        return;
    }

    eventsLoaded = data;

    calendar.removeAllEvents();
    data.forEach(evt =>
        calendar.addEvent({ 
            id: evt.id, 
            title: evt.title, 
            start: evt.start 
        })
    );

    updateEventSelectors();
}

/* CALENDÁRIO */
function initCalendar() {
    if (calendar) return;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
    });
    calendar.render();
}

/* ADICIONAR EVENTO */
addEventBtn.addEventListener("click", async () => {
    const title = eventTitleInput.value.trim();
    const date = eventDateInput.value;

    if (!title || !date) return alert("Preencha tudo!");

    const { error } = await supabaseClient
        .from("events")
        .insert([{ title, start: date }]);

    if (error) return alert("Erro ao criar evento: " + error.message);

    eventTitleInput.value = "";
    eventDateInput.value = "";
    loadEvents();
});

/* ATUALIZAR SELECTS */
function updateEventSelectors() {
    presenceSelect.innerHTML = "";
    removeSelect.innerHTML = "";

    if (eventsLoaded.length === 0) {
        presenceSelect.innerHTML = "<option>Nenhum evento</option>";
        removeSelect.innerHTML = "<option>Nenhum evento</option>";
        return;
    }

    eventsLoaded.forEach(evt => {
        const txt = `${evt.title} — ${new Date(evt.start).toLocaleString()}`;
        presenceSelect.innerHTML += `<option value="${evt.id}">${txt}</option>`;
        removeSelect.innerHTML += `<option value="${evt.id}">${txt}</option>`;
    });

    loadPresenceList();
}

/* CONFIRMAR PRESENÇA */
confirmPresenceBtn.addEventListener("click", async () => {
    const eventId = presenceSelect.value;

    const { data: exist } = await supabaseClient
        .from("presence")
        .select("*")
        .eq("event_id", eventId)
        .eq("user_name", currentUser);

    if (exist.length > 0)
        return alert("Você já confirmou!");

    const { error } = await supabaseClient
        .from("presence")
        .insert([{ 
            event_id: eventId, 
            user_name: currentUser,
            date: new Date().toISOString()
        }]);

    if (error) return alert("Erro: " + error.message);

    loadPresenceList();
});

/* LISTAR PRESENÇAS */
async function loadPresenceList() {
    presenceList.innerHTML = "";

    const eventId = presenceSelect.value;

    const { data, error } = await supabaseClient
        .from("presence")
        .select("*")
        .eq("event_id", eventId);

    if (error) return;

    data.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.user_name;
        presenceList.appendChild(li);
    });
}

/* REMOVER EVENTO */
removeBtn.addEventListener("click", async () => {
    const id = removeSelect.value;

    if (!confirm("Tem certeza?")) return;

    await supabaseClient.from("presence").delete().eq("event_id", id);
    await supabaseClient.from("events").delete().eq("id", id);

    alert("Evento removido!");
    loadEvents();
});

loadUser();
</script>

</body>
</html>
