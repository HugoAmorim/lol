<script>
/* ================ CONFIG SUPABASE ================ */
const supabaseUrl = "https://omhpfutnbrjkctdsnqzm.supabase.co";
const supabaseKey =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taHBmdXRuYnJqa2N0ZHNucXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTc5MDIsImV4cCI6MjA4MDE3MzkwMn0.ivNsJ21QVegUSgdc4aw9dyV85QJuEq7--bpkcKj5zVI";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* HTML ELEMENTOS */
const loginBox = document.getElementById('login-box');
const mainBox = document.getElementById('main');
const loginBtn = document.getElementById('login-btn');
const loginInput = document.getElementById('login-name');
const playerNameSpan = document.getElementById('player-name');

const addEventBtn = document.getElementById('add-event-btn');
const eventTitleInput = document.getElementById('event-title');
const eventDateInput = document.getElementById('event-date');

const presenceSelect = document.getElementById('presence-event-select');
const confirmPresenceBtn = document.getElementById('confirm-presence-btn');
const presenceList = document.getElementById('presence-list');

const removeSelect = document.getElementById('remove-event-select');
const removeBtn = document.getElementById('remove-event-btn');

const calendarEl = document.getElementById('calendar');

let calendar = null;
let currentUser = null;
let eventsLoaded = [];

/* LOGIN */
loginBtn.addEventListener('click', login);
loginInput.addEventListener('keyup', e => { if (e.key === 'Enter') login(); });

function login() {
    const name = loginInput.value.trim();
    if (!name) return alert("Digite um nickname!");

    currentUser = name;
    localStorage.setItem("lol_user", name);

    loadUser();
}

function loadUser() {
    const saved = localStorage.getItem("lol_user");
    if (!saved) return;

    currentUser = saved;
    playerNameSpan.innerText = saved;

    loginBox.classList.add('hidden');
    mainBox.classList.remove('hidden');

    initCalendar();
    loadEvents();
}

/* CARREGAR EVENTOS */
async function loadEvents() {
    const { data, error } = await supabaseClient
        .from("events")
        .select("*")
        .order("start");

    if (error) {
        alert("Erro ao carregar eventos: " + error.message);
        return;
    }

    eventsLoaded = data;

    calendar.removeAllEvents();
    data.forEach(evt =>
        calendar.addEvent({ 
            id: evt.id, 
            title: evt.title, 
            start: evt.start 
        })
    );

    updateEventSelectors();
}

/* CALENDÁRIO */
function initCalendar() {
    if (calendar) return;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
    });
    calendar.render();
}

/* ADICIONAR EVENTO */
addEventBtn.addEventListener("click", async () => {
    const title = eventTitleInput.value.trim();
    const date = eventDateInput.value;

    if (!title || !date) return alert("Preencha tudo!");

    const { error } = await supabaseClient
        .from("events")
        .insert([{ title, start: date }]);

    if (error) return alert("Erro ao criar evento: " + error.message);

    eventTitleInput.value = "";
    eventDateInput.value = "";

    loadEvents();
});

/* ATUALIZAR SELECTS */
function updateEventSelectors() {
    presenceSelect.innerHTML = "";
    removeSelect.innerHTML = "";

    if (eventsLoaded.length === 0) {
        presenceSelect.innerHTML = "<option>Nenhum evento</option>";
        removeSelect.innerHTML = "<option>Nenhum evento</option>";
        return;
    }

    eventsLoaded.forEach(evt => {
        const text = `${evt.title} — ${new Date(evt.start).toLocaleString()}`;
        presenceSelect.innerHTML += `<option value="${evt.id}">${text}</option>`;
        removeSelect.innerHTML += `<option value="${evt.id}">${text}</option>`;
    });

    loadPresenceList();
}

/* CONFIRMAR PRESENÇA */
confirmPresenceBtn.addEventListener("click", async () => {
    const eventId = presenceSelect.value;

    const { data: existing } = await supabaseClient
        .from("presence")
        .select("*")
        .eq("event_id", eventId)
        .eq("user_name", currentUser);

    if (existing.length > 0)
        return alert("Você já confirmou presença!");

    const { error } = await supabaseClient
        .from("presence")
        .insert([{ 
            event_id: eventId, 
            user_name: currentUser,
            date: new Date().toISOString()
        }]);

    if (error) return alert("Erro ao confirmar presença: " + error.message);

    loadPresenceList();
});

/* LISTAR PRESENÇAS */
async function loadPresenceList() {
    presenceList.innerHTML = "";

    const eventId = presenceSelect.value;

    const { data, error } = await supabaseClient
        .from("presence")
        .select("*")
        .eq("event_id", eventId);

    if (error) return;

    data.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.user_name;
        presenceList.appendChild(li);
    });
}

/* REMOVER EVENTO */
removeBtn.addEventListener("click", async () => {
    const id = removeSelect.value;

    if (!confirm("Tem certeza?")) return;

    await supabaseClient.from("presence").delete().eq("event_id", id);
    await supabaseClient.from("events").delete().eq("id", id);

    loadEvents();
    alert("Evento removido!");
});

loadUser();
</script>
