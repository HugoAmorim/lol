<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Gerenciamento de Treinos - LoL</title>

<!-- FULLCALENDAR -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    font-family: Arial, sans-serif;
    color: white;
    margin: 0;
    background-image: url("https://i.imgur.com/VRfZp3v.jpeg");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
}
body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(3px);
    z-index: -1;
}
.container {
    max-width: 980px;
    margin: 30px auto;
    padding: 20px;
}
.box {
    background: rgba(20,20,20,0.9);
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 24px;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}
input, select, button {
    padding: 10px;
    margin-top: 10px;
    width: 100%;
    border-radius: 6px;
    border: none;
}
input, select {
    background: #2b2b2b;
    color: white;
}
button {
    background: #0b74d1;
    color: white;
    font-weight: bold;
    cursor: pointer;
}
button:hover { background: #0d86ff; }
.hidden { display: none; }
</style>
</head>
<body>
<div class="container">

    <!-- LOGIN -->
    <div id="login-box" class="box">
        <h2>Login</h2>
        <p>Digite seu nickname</p>
        <input id="login-name" placeholder="Ex: Pedr0zin" />
        <button id="login-btn">Entrar</button>
    </div>

    <!-- APP -->
    <div id="main" class="hidden">
        <h2>Bem-vindo, <span id="player-name"></span>!</h2>

        <!-- Calendário -->
        <div id="calendar" class="box"></div>

        <!-- Criar Evento -->
        <div class="box">
            <h3>Criar Evento</h3>
            <input id="event-title" placeholder="Nome do evento" />
            <input id="event-date" type="datetime-local" />
            <button id="add-event-btn">Adicionar Evento</button>
        </div>

        <!-- Remover Evento -->
        <div class="box">
            <h3>Remover Evento</h3>
            <select id="remove-event-select"></select>
            <button id="remove-event-btn">Remover Evento Selecionado</button>
        </div>

        <!-- Presença -->
        <div class="box">
            <h3>Confirmar Presença</h3>
            <select id="presence-event-select"></select>
            <button id="confirm-presence-btn">Confirmar Presença</button>

            <h4 style="margin-top:14px">Confirmações</h4>
            <ul id="presence-list" style="padding-left:18px"></ul>
        </div>
    </div>
</div>

<script>
/* ================ CONFIG SUPABASE ================ */
const supabaseUrl = "https://omhpfutnbrjkctdsnqzm.supabase.co";
const supabaseKey =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taHBmdXRuYnJqa2N0ZHNucXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTc5MDIsImV4cCI6MjA4MDE3MzkwMn0.ivNsJ21QVegUSgdc4aw9dyV85QJuEq7--bpkcKj5zVI";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* HTML ELEMENTOS */
const loginBox = document.getElementById('login-box');
const mainBox = document.getElementById('main');
const loginBtn = document.getElementById('login-btn');
const loginInput = document.getElementById('login-name');
const playerNameSpan = document.getElementById('player-name');

const addEventBtn = document.getElementById('add-event-btn');
const eventTitleInput = document.getElementById('event-title');
const eventDateInput = document.getElementById('event-date');

const presenceSelect = document.getElementById('presence-event-select');
const confirmPresenceBtn = document.getElementById('confirm-presence-btn');
const presenceList = document.getElementById('presence-list');

const removeSelect = document.getElementById('remove-event-select');
const removeBtn = document.getElementById('remove-event-btn');

const calendarEl = document.getElementById('calendar');

let calendar = null;
let currentUser = null;
let eventsLoaded = [];

/* LOGIN */
loginBtn.addEventListener('click', login);
loginInput.addEventListener('keyup', e => { if (e.key === 'Enter') login(); });

function login() {
    const name = loginInput.value.trim();
    if (!name) return alert("Digite um nickname!");

    currentUser = name;
    localStorage.setItem("lol_user", name);

    loadUser();
}

function loadUser() {
    const saved = localStorage.getItem("lol_user");
    if (!saved) return;

    currentUser = saved;
    playerNameSpan.innerText = saved;

    loginBox.classList.add('hidden');
    mainBox.classList.remove('hidden');

    initCalendar();
    loadEvents();
}

/* CARREGAR EVENTOS */
async function loadEvents() {
    const { data, error } = await supabaseClient
        .from("events")
        .select("*")
        .order("date");

    if (error) {
        console.error(error);
        alert("Erro ao carregar eventos: " + error.message);
        return;
    }

    eventsLoaded = data;

    calendar.removeAllEvents();
    data.forEach(evt =>
        calendar.addEvent({ id: evt.id, title: evt.title, start: evt.date })
    );

    updateEventSelectors();
}

/* CALENDARIO */
function initCalendar() {
    if (calendar) return;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
    });
    calendar.render();
}

/* ADICIONAR EVENTO */
addEventBtn.addEventListener("click", async () => {
    const title = eventTitleInput.value.trim();
    const date = eventDateInput.value;

    if (!title || !date) return alert("Preencha tudo!");

    const { error } = await supabaseClient
        .from("events")
        .insert([{ title, date }]);

    if (error) return alert("Erro ao criar evento: " + error.message);

    eventTitleInput.value = "";
    eventDateInput.value = "";

    loadEvents();
});

/* SELECT DOS EVENTOS */
function updateEventSelectors() {
    presenceSelect.innerHTML = "";
    removeSelect.innerHTML = "";

    if (eventsLoaded.length === 0) {
        presenceSelect.innerHTML = "<option>Nenhum evento</option>";
        removeSelect.innerHTML = "<option>Nenhum evento</option>";
        return;
    }

    eventsLoaded.forEach(evt => {
        const text = `${evt.title} — ${new Date(evt.date).toLocaleString()}`;
        presenceSelect.innerHTML += `<option value="${evt.id}">${text}</option>`;
        removeSelect.innerHTML += `<option value="${evt.id}">${text}</option>`;
    });

    loadPresenceList();
}

/* CONFIRMAR PRESENÇA */
confirmPresenceBtn.addEventListener("click", async () => {
    const eventId = presenceSelect.value;

    const { data: existing } = await supabaseClient
        .from("presences")
        .select("*")
        .eq("event_id", eventId)
        .eq("name", currentUser);

    if (existing.length > 0)
        return alert("Você já confirmou presença!");

    const { error } = await supabaseClient
        .from("presences")
        .insert([{ event_id: eventId, name: currentUser }]);

    if (error) return alert("Erro ao confirmar presença");

    loadPresenceList();
});

/* LISTAR PRESENÇA */
async function loadPresenceList() {
    presenceList.innerHTML = "";

    const eventId = presenceSelect.value;

    const { data, error } = await supabaseClient
        .from("presences")
        .select("*")
        .eq("event_id", eventId);

    if (error) return;

    data.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.name;
        presenceList.appendChild(li);
    });
}

/* REMOVER EVENTO */
removeBtn.addEventListener("click", async () => {
    const id = removeSelect.value;

    if (!confirm("Tem certeza?")) return;

    await supabaseClient.from("presences").delete().eq("event_id", id);
    await supabaseClient.from("events").delete().eq("id", id);

    loadEvents();
    alert("Evento removido!");
});

loadUser();
</script>
</body>
</html>
